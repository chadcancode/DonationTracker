<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Donations</title>
<style>
  :root{--pad:14px;--gap:10px;--radius:12px;}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;margin:0;background:#f6f7fb;color:#111;}
  .wrap{max-width:900px;margin:0 auto;padding:var(--pad);}
  .tabs{display:flex;gap:8px;margin:6px 0 14px;}
  .tab{flex:1;text-align:center;padding:12px;border-radius:999px;background:#e9ecf4;font-weight:600;cursor:pointer;}
  .tab.active{background:#111;color:#fff;}
  .card{background:#fff;border-radius:var(--radius);padding:var(--pad);box-shadow:0 2px 10px rgba(0,0,0,0.06);}
  .grid{display:grid;grid-template-columns:1fr;gap:var(--gap);}
  @media (min-width:800px){.grid{grid-template-columns:1fr 1fr;}}
  label{font-size:12px;font-weight:600;color:#555;margin-bottom:4px;display:block;}
  input,select,button,textarea{width:100%;padding:12px 11px;border-radius:10px;border:1px solid #dcdfe6;background:#fff;}
  input[type="date"]{padding:10px;}
  .muted{font-size:12px;color:#667;}
  .pill{display:inline-block;background:#fffae7;border:1px solid #f1e2a3;color:#775d00;border-radius:999px;padding:4px 10px;font-size:12px;margin-left:8px;}
  .list{margin-top:12px;border-top:1px dashed #e2e6f0;padding-top:10px;}
  .item{display:grid;grid-template-columns: 1.8fr .9fr .7fr 1fr 1.3fr;gap:8px;margin-bottom:12px}
  .meta{grid-column:1/-1;font-size:12px;color:#445;margin-top:-4px}
  @media (max-width:560px){
    .item{grid-template-columns:1fr 1fr}
    .meta{grid-column:1/-1}
  }
  .actions{display:flex;gap:10px;margin-top:10px}
  .btn-primary{background:#111;color:#fff;border:0;font-weight:700}
  .btn-ghost{background:#eef1f7;border-color:#e1e5ee}
  .sum{margin-top:8px;text-align:right;font-weight:700}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#111;color:#fff;padding:10px 14px;border-radius:999px;opacity:0;transition:.2s}
  .toast.show{opacity:1}
  button:disabled{opacity:.55;filter:grayscale(20%);cursor:not-allowed}
</style>
</head>
<body>
<div class="wrap">
  <div class="tabs">
    <div id="tab-cash" class="tab active" onclick="showTab('cash')">Cash</div>
    <div id="tab-items" class="tab" onclick="showTab('items')">Items</div>
  </div>

  <!-- CASH -->
  <div id="view-cash" class="card">
    <div class="grid">
      <div>
        <label>Organization</label>
        <select id="cashOrg"></select>
      </div>
      <div>
        <label>Date</label>
        <input id="cashDate" type="date">
      </div>
      <div>
        <label>Amount</label>
        <input id="cashAmount" type="number" min="0" step="0.01" placeholder="0.00">
      </div>
      <div>
        <label>Method</label>
        <select id="cashMethod">
          <option>Cash</option><option>Credit Card</option>
        </select>
      </div>
    </div>
    <div class="grid" style="margin-top:10px">
      <div>
        <label>New Charity (optional)</label>
        <input id="cashNewOrg" placeholder="Name">
      </div>
      <div>
        <label>New Charity Address (optional)</label>
        <input id="cashNewAddr" placeholder="Address">
      </div>
    </div>
    <div class="actions">
      <button id="btnCash" class="btn-primary" onclick="submitCash()">Submit Cash</button>
      <span class="muted">Use New Charity fields if first time.</span>
    </div>
  </div>

  <!-- ITEMS -->
  <div id="view-items" class="card" style="display:none">
    <div class="grid">
      <div>
        <label>Organization</label>
        <select id="itemsOrg"></select>
      </div>
      <div>
        <label>Date</label>
        <input id="itemsDate" type="date">
      </div>
    </div>
    <div class="grid" style="margin-top:10px">
      <div>
        <label>New Charity (optional)</label>
        <input id="itemsNewOrg" placeholder="Name">
      </div>
      <div>
        <label>New Charity Address (optional)</label>
        <input id="itemsNewAddr" placeholder="Address">
      </div>
    </div>

    <div class="muted" style="margin-top:8px">Add items <span class="pill">FMV auto from guide</span></div>
    <div class="list" id="itemsList"></div>
    <div class="sum" id="sum">Total: $0.00</div>
    <div class="actions">
      <button class="btn-ghost" onclick="addRow()">+ Add item</button>
      <button id="btnItems" class="btn-primary" onclick="submitItems()">Submit Items</button>
    </div>
  </div>
</div>

<!-- One global datalist for all rows -->
<datalist id="items-dl"></datalist>

<div id="toast" class="toast"></div>

<script>
let charities=[], items=[];

/* ---------- UI helpers ---------- */
function showTab(which){
  document.getElementById('tab-cash').classList.toggle('active', which==='cash');
  document.getElementById('tab-items').classList.toggle('active', which==='items');
  document.getElementById('view-cash').style.display  = which==='cash'  ? 'block' : 'none';
  document.getElementById('view-items').style.display = which==='items' ? 'block' : 'none';
}
function toast(msg){
  const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),1800);
}
function opt(el, text, value){
  const o=document.createElement('option'); o.textContent=text; o.value=value??text; el.appendChild(o);
}
function currency(n){ return (n||0).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2}); }
function computeFMV(low, high, condition){
  if (!(low>0) || !(high>0)) return null;
  const mid=(low+high)/2;
  const f = condition==="Poor"?0.8:condition==="Fair"?0.9:condition==="Excellent"?1.1:1.0;
  const raw=mid*f;
  return Math.max(low, Math.min(high, raw));
}
function lock(btn, on=true){ btn.disabled = on; if (on) btn.dataset.busy="1"; else delete btn.dataset.busy; }

/* ---------- Items list row ---------- */
function addRow(prefill={}){
  const row=document.createElement('div'); row.className='item';
  row.innerHTML = `
    <input class="name" placeholder="Item (start typing)" list="items-dl">
    <select class="cond">
      <option>Poor</option><option>Fair</option><option selected>Good</option><option>Excellent</option>
    </select>
    <input class="qty" type="number" min="1" value="1">
    <input class="over" placeholder="Override FMV" type="number" min="0" step="0.01">
    <input class="note" placeholder="Notes (optional)">
    <div class="meta">Low — High: <span class="rng">—</span> • Suggested FMV: <span class="sugg">—</span> • Line Total: <span class="line">—</span></div>
  `;

  const elName=row.querySelector('.name'), elCond=row.querySelector('.cond'), elQty=row.querySelector('.qty'),
        elOver=row.querySelector('.over'), elRng=row.querySelector('.rng'),
        elSugg=row.querySelector('.sugg'), elLine=row.querySelector('.line');

  let pending=0;
  function refresh(){
    const name = elName.value.trim();
    const qty  = Number(elQty.value||1)||1;
    const cond = elCond.value;
    if (!name){ elRng.textContent="—"; elSugg.textContent="—"; elLine.textContent="—"; recalcSum(); return; }

    const ticket=++pending;
    google.script.run
      .withFailureHandler(err => { console.log("lookupItem error:", err); })
      .withSuccessHandler(res=>{
        if (ticket!==pending) return;
        if (res.ok === false){ console.log("lookupItem failed:", res.error||""); elRng.textContent="—"; elSugg.textContent="—"; elLine.textContent="—"; return; }
        const low = res.low, high = res.high;
        let fmv=null;
        if (low>0 && high>0){
          fmv = computeFMV(low, high, cond);
          elRng.textContent = `$${currency(low)} — $${currency(high)}`;
          elSugg.textContent = fmv ? `$${currency(fmv)}` : "—";
        } else { elRng.textContent = "—"; elSugg.textContent = "—"; }
        const use = (elOver.value && Number(elOver.value)>0) ? Number(elOver.value) : (fmv||0);
        elLine.textContent = use>0 ? `$${currency(use*qty)}` : "—";
        recalcSum();
      })
      .lookupItem(name);
  }
  ['change','input','blur'].forEach(evt=>{
    elName.addEventListener(evt, refresh);
    elCond.addEventListener(evt, refresh);
    elQty.addEventListener(evt, refresh);
    elOver.addEventListener(evt, refresh);
  });

  if (prefill.item) elName.value = prefill.item;
  document.getElementById('itemsList').appendChild(row);
}

/* ---------- Totals ---------- */
function recalcSum(){
  let total=0;
  [...document.getElementById('itemsList').children].forEach(r=>{
    const txt=r.querySelector('.line').textContent.replace(/[^0-9.]/g,''); total += Number(txt||0);
  });
  document.getElementById('sum').textContent = `Total: $${currency(total)}`;
}

/* ---------- Load data ---------- */
function loadData(){
  // Charities
  google.script.run
    .withFailureHandler(err => {
      console.log("listCharities error:", err);
      toast("Can't load charities. Check sheet access & sign-in.");
    })
    .withSuccessHandler(res => {
      const payload = res || {ok:false, data:[]};
      if (payload.ok === false) {
        console.log("listCharities failed:", payload.error||"");
        toast("Charity list unavailable. Confirm SHEET_ID & sharing.");
      }
      charities = payload.data || [];
      const sel1 = document.getElementById('cashOrg');
      const sel2 = document.getElementById('itemsOrg');
      sel1.innerHTML=""; sel2.innerHTML="";
      if (!charities.length){
        opt(sel1, "— No charities yet —", "");
        opt(sel2, "— No charities yet —", "");
      } else {
        opt(sel1, "— Select —", ""); opt(sel2, "— Select —", "");
        charities.forEach(c => { opt(sel1, c.name, c.name); opt(sel2, c.name, c.name); });
      }
      const today = new Date().toISOString().slice(0,10);
      document.getElementById('cashDate').value = today;
      document.getElementById('itemsDate').value = today;
    })
    .listCharities();

  // Items for global datalist
  google.script.run
    .withFailureHandler(err => {
      console.log("listItems error:", err);
      toast("Can't load value guide. Check sheet access & sign-in.");
    })
    .withSuccessHandler(res => {
      const payload = res || {ok:false, data:[]};
      if (payload.ok === false) {
        console.log("listItems failed:", payload.error||"");
        toast("Value guide unavailable. Confirm SHEET_ID & sharing.");
      }
      items = payload.data || [];
      const dl = document.getElementById('items-dl'); dl.innerHTML = "";
      items.forEach(it => { const o=document.createElement('option'); o.value = it.item; dl.appendChild(o); });
      if (document.getElementById('itemsList').children.length===0) addRow();
    })
    .listItems();
}

/* ---------- Submit handlers ---------- */
function submitCash(){
  const btn = document.getElementById('btnCash');
  if (btn.dataset.busy === "1") return;

  const org     = document.getElementById('cashOrg').value.trim();
  const newOrg  = document.getElementById('cashNewOrg').value.trim();
  const dateISO = document.getElementById('cashDate').value;
  const amount  = Number(document.getElementById('cashAmount').value || 0);

  if (!org && !newOrg) { toast("Pick an organization or enter a new one."); return; }
  if (!dateISO)        { toast("Please choose a date."); return; }
  if (!(amount > 0))   { toast("Amount must be > 0."); return; }
  if (!confirm(`Submit cash: $${amount.toFixed(2)}?`)) return;

  const payload = {
    org,
    newOrg,
    newAddr: document.getElementById('cashNewAddr').value,
    dateISO,
    amount,
    method: document.getElementById('cashMethod').value
  };

  lock(btn, true);
  google.script.run
    .withFailureHandler(err => { toast("Error: "+err); lock(btn,false); })
    .withSuccessHandler(() => {
      toast("Cash donation recorded");
      document.getElementById('cashAmount').value="";
      document.getElementById('cashNewOrg').value="";
      document.getElementById('cashNewAddr').value="";
      lock(btn,false);
    })
    .submitCash(payload);
}

function submitItems(){
  const btn = document.getElementById('btnItems');
  if (btn.dataset.busy === "1") return;

  const org     = document.getElementById('itemsOrg').value.trim();
  const newOrg  = document.getElementById('itemsNewOrg').value.trim();
  const dateISO = document.getElementById('itemsDate').value;

  if (!org && !newOrg) { toast("Pick an organization or enter a new one."); return; }
  if (!dateISO)        { toast("Please choose a date."); return; }

  const rows=[...document.getElementById('itemsList').children];
  const lines = rows.map(r=>{
    const name = r.querySelector('.name').value.trim();
    const cond = r.querySelector('.cond').value;
    const qty  = Number(r.querySelector('.qty').value || 1) || 1;
    const over = r.querySelector('.over').value;
    const note = r.querySelector('.note').value;
    const totalTxt = r.querySelector('.line').textContent.replace(/[^0-9.]/g,''); // UI-computed
    const totalNum = Number(totalTxt || 0);
    return { item:name, condition:cond, qty, override:over, note, _total:totalNum };
  });

  const hasAny = lines.some(l => l.item && (l._total > 0 || Number(l.override) > 0));
  if (!hasAny) { toast("Add at least one item with a value."); return; }
  if (!confirm("Submit item donation?")) return;

  const payload = {
    org,
    newOrg,
    newAddr: document.getElementById('itemsNewAddr').value,
    dateISO,
    lines: lines.map(({item,condition,qty,override,note}) => ({item,condition,qty,override,note}))
  };

  lock(btn, true);
  google.script.run
    .withFailureHandler(err => { toast("Error: "+err); lock(btn,false); })
    .withSuccessHandler(res=>{
      toast(`Recorded ${res.lines||0} item(s)`);
      document.getElementById('itemsList').innerHTML="";
      addRow();
      document.getElementById('itemsNewOrg').value="";
      document.getElementById('itemsNewAddr').value="";
      recalcSum();
      lock(btn,false);
    })
    .submitItems(payload);
}

document.addEventListener('DOMContentLoaded', loadData);
</script>
</body>
</html>
